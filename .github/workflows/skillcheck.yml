name: SKILLCHECK

on:
  push:
    branches: ["master"]
  pull_request:

jobs:
  audit:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]
      - name: Ruff lint
        run: ruff check .
      - name: Mypy type check
        run: mypy skillcheck
      - name: Run unit tests
        run: pytest -q
      - name: Build package
        run: python -m build
      - name: Lint safe sample
        run: python -m skillcheck.cli lint examples/brand-voice-editor --output-dir .skillcheck --policy-pack balanced --policy-version 2
      - name: Probe safe sample
        run: |
          SKILLCHECK_PROBE_EXEC=1 python -m skillcheck.cli probe examples/brand-voice-editor --output-dir .skillcheck --exec --policy-pack balanced --policy-version 2
      - name: Lint risky sample (expected failure)
        run: |
          if python -m skillcheck.cli lint examples/risky-net-egress --output-dir .skillcheck; then
            echo "Expected lint command to fail for risky skill" >&2
            exit 1
          fi
      - name: Probe risky sample (expected failure)
        run: |
          if SKILLCHECK_PROBE_EXEC=1 python -m skillcheck.cli probe examples/risky-net-egress --output-dir .skillcheck --exec; then
            echo "Expected probe command to fail for risky skill" >&2
            exit 1
          fi
      - name: Aggregate report
        run: python -m skillcheck.cli report . --artifacts .skillcheck --summary --sarif --release-gate standard
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: .skillcheck/results.sarif
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: skillcheck-artifacts
          path: |
            .skillcheck/*.json
            .skillcheck/results.*
            .skillcheck/*.png
